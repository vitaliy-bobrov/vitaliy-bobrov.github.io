<html><head><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content="@bobrov1989"><meta name="twitter:title" content="Web Audio for Electric Guitar: How to Connect Instrument"><meta name="twitter:description" content="Want to connect your electric guitar in a browser using Web Audio API? This short tutorial shows how to do it! You will learn how to request audio access, convert it into an audio stream and control volume."><meta name="twitter:image" content="https://bobrov.dev/images/posts/web-audio-for-electric-guitar-how-to-connect-instrument/web-audio-for-electric-guitar-how-to-connect-instrument-og.jpg"><meta name="twitter:image:alt" content="Web Audio for Electric Guitar: How to Connect Instrument"></head><body><p>Modern Web becomes more and more powerful, especially with APIs giving developers access to hardware. One of such API ‚Äì Web Audio. It gives you a set of low-level features to generate or process music right in your browser. Today I want to show you how to connect your electric guitar üé∏ (or any other electric instrument with wire connection, ex. bass) in a browser and control its volume level.</p>
<p><em>This post is a part of ‚ÄúWeb Audio for Electric Guitar‚Äù series, check out other posts as well!</em></p>
<h3 class="post__series">Web Audio for Electric Guitar:</h3>
<ol class="post__series"><li>How to Connect Instrument ‚Äì Current</li>
<li><a href="https://bobrov.dev/blog/web-audio-for-electric-guitar-cabinet-emulation/">Cabinet Emulation</a></li>
<li><a href="https://bobrov.dev/blog/web-audio-for-electric-guitar-distortion">Distortion</a></li>
</ol>
<p>I am playing a bunch of instruments, including some very unusual, like <a href="https://en.wikipedia.org/wiki/Bandura" target="_blank" rel="nofollow noreferrer noopener">bandura</a> ü§Ø, but my favorite one is a guitar. At my teenage years, I‚Äôve used to play at punk-rock bands ü§ò at school and university. I‚Äôm not a professional guitarist, and it is just my hobby that helps to relax and clean my mind after work. Web Audio allowed me to combine programming and music, so I‚Äôve started experimenting with it. The very first task to do that was how to connect my instrument to the laptop.</p>
<p class="js-lazy-load"><img src="/images/posts/web-audio-for-electric-guitar-how-to-connect-instrument/img/punk-rock-band.jpg" alt="Me playing punk rock at age of 16"></p>
<h2>Hardware</h2>
<p>Before writing any code, you need a few things: a laptop, an instrument (electric guitar in my case) and an audio interface. The last part is crucial. Of course, you can plug your instrument directly to the audio input of your computer, but it has a bunch of downsides. First, it might require an adapter. Usually, laptops have only 3.5mm jack, but 6.4mm cables used for instruments. Second, the quality of built-in audio cards is not usually suitable for playing music ‚Äì in most cases, producers think that users use it for music, movies, and games. You should expect a high latency of an audio stream. Moreover, the last argument in favor of functional interface, that build-in solutions might be damaged on hard input levels. I did that when I was young üò±.</p>
<p>Fortunately, you can buy a cheap and good-to-start device just for 20-25$. I‚Äôm using the most popular and quite cheap one ‚Äì Behringer UCG-102 Guitar Link (this is not an advertisement!). It gives a low latency, has 6.4mm jack input and output, connects via USB and doesn‚Äôt require any particular setup to work on Mac (on Windows you might need to install <code>asio4all</code> driver to achieve good results). You can see it among my devices on the photo below.</p>
<p class="js-lazy-load"><img src="/images/posts/web-audio-for-electric-guitar-how-to-connect-instrument/img/web-audio-kit.jpg" alt="My Web Audio devices: Squier by Fender Mustang, Behringer UCG-102, MacBook Pro, cables, picks"></p>
<p>You can buy something more fancy and better, but this audio interface is good to start with, you can always upgrade it if you ever need it.</p>
<p>You need to connect your device to the computer, connect the instrument to the interface. Then you need to make sure that your system audio input and output setup is correct. You must select an external audio card as input and select built-in one as an output.</p>
<p><em>Note: if you want to use Bluetooth headphones to play, I‚Äôd like to recommend to use an only wired connection, at least when I used Marshall MID the latency was so huge that I couldn‚Äôt play anything, they worked fine for me to listen to the music. It might be only my specific problem, but when trying to use Web Audio at first time try not to use wireless speakers or headphones, as they might add latency and make you think Web Audio API to be slow.</em></p>
<h2>Web Audio Context</h2>
<p>Before you request user audio input, you need to create a Web Audio context ‚Äì the main point to create any nodes and work with APIs. Web Audio, in general, is a uni-directed graph of individual audio nodes. Connecting and changing their parameters, you could create effects pipeline or generate sound. That graph should have some input, in our case audio stream from the guitar signal.</p>
<p class="js-lazy-load"><img src="/images/posts/web-audio-for-electric-guitar-how-to-connect-instrument/img/web-audio-graph.jpg" alt="Web Audio graph representation"></p>
<p>To produce any noise or sound out, the input should be connected to the output. Usually, it is a context destination ‚Äì the output device configured in the system. You can imagine it as a standard guitar stack. We have a guitar that could be connected to a line of stompboxes (guitar pedals), and at the end, you connect it to an amplifier or cabinet.</p>
<p class="js-lazy-load"><img src="/images/posts/web-audio-for-electric-guitar-how-to-connect-instrument/img/guitar-stack.jpg" alt="Guitar stack schema"></p>
<p>Sometimes, for ease of use, it is helpful to draw a graph before implementing any complex effect.</p>
<p>Let‚Äôs create the audio context, to do so we need to use a constructor that returns context:</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AudioContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>The friend of mine <a href="https://twitter.com/thekiba_io" target="_blank" rel="nofollow noreferrer noopener">Reactive Fox</a> pointed me that you might have a problem with an audio context that created without any user interaction, ex. click. Browsers could set such context in a suspended state; you can read about it in details <a href="https://developers.google.com/web/updates/2017/09/autoplay-policy-changes#webaudio" target="_blank" rel="nofollow noreferrer noopener">here</a>. To prevent such issues, you need to make sure that the context is in the active state using the following code:</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">if</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span>state <span class="token operator">===</span> <span class="token string">'suspended'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">await</span> context<span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p><em>Side note: I‚Äôve used TypeScript while working with Web Audio and it saved me much time of searching through the documentation. It is not required to use TypeScript, but I can say it might make your life way easier.</em></p>
<h2>Request audio stream</h2>
<p>After we created an audio context, we are ready to request user input with <code>getUserMedia</code> API. In the past, this method was located on <code>navigator</code> object, but the specification was changed, and now it is on <code>navigator.mediaDevices</code>. Keep this in mind if you‚Äôre going to support legacy browsers.</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> stream <span class="token operator">=</span> <span class="token keyword">await</span> navigator<span class="token punctuation">.</span>mediaDevices
  <span class="token punctuation">.</span><span class="token function">getUserMedia</span><span class="token punctuation">(</span><span class="token punctuation">{</span>audio<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>By default, browsers might apply sound optimization to the stream ‚Äì echo cancellation, noise suppression, and auto gain control. Those optimizations are suitable for a microphone but not for a live instrument. To disable them, you need to pass an object with audio constraints instead of <code>true</code>:</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> stream <span class="token operator">=</span> <span class="token keyword">await</span> navigator<span class="token punctuation">.</span>mediaDevices
  <span class="token punctuation">.</span><span class="token function">getUserMedia</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    audio<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      echoCancellation<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      autoGainControl<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      noiseSuppression<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      latency<span class="token punctuation">:</span> <span class="token number">0</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>After the call of the method, the user will be asked for permission to allow audio input and output. You can request those permissions manually using <code>Permissions API</code>, but that feature is not fully supported right now. For now, you‚Äôre allowed to check permission status and reset it.</p>
<pre class="language-js"><code class="language-js"><span class="token comment">// Getting permission status.</span>
<span class="token keyword">const</span> micStatus <span class="token operator">=</span> <span class="token keyword">await</span> navigator<span class="token punctuation">.</span>permissions<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">{</span>name<span class="token punctuation">:</span> <span class="token string">'microphone'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>micStatus<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// state: "prompt"</span>

<span class="token comment">// Reset permission to initial state.</span>
<span class="token keyword">await</span> navigator<span class="token punctuation">.</span>permissions<span class="token punctuation">.</span><span class="token function">revoke</span><span class="token punctuation">(</span><span class="token punctuation">{</span>name<span class="token punctuation">:</span> <span class="token string">'microphone'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p><em>Note: <code>getUserMedia</code> user media requires your app to be hosted via secure connection ‚Äì HTTPS. If your local or deployed app is running using HTTP, you might need to grant permissions using web site settings in a browser manually.</em></p>
<p>Ok, we requested an audio stream, what next? We need to create a media stream source and pass that stream to the audio context. However, to get any sound from the speakers, we must connect our source to destination node:</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> lineInSource <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">createMediaStreamSource</span><span class="token punctuation">(</span>stream<span class="token punctuation">)</span><span class="token punctuation">;</span>

lineInSource<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>destination<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>And ü•Å‚Ä¶ now you should hear sound from the guitar in your browser ‚Äì congratulations üéâ! Let‚Äôs put it all together:</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AudioContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span>state <span class="token operator">===</span> <span class="token string">'suspended'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">await</span> context<span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> stream <span class="token operator">=</span> <span class="token keyword">await</span> navigator<span class="token punctuation">.</span>mediaDevices
  <span class="token punctuation">.</span><span class="token function">getUserMedia</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    audio<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      echoCancellation<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      autoGainControl<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      noiseSuppression<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      latency<span class="token punctuation">:</span> <span class="token number">0</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> lineInSource <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">createMediaStreamSource</span><span class="token punctuation">(</span>stream<span class="token punctuation">)</span><span class="token punctuation">;</span>

lineInSource<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>destination<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>To disconnect your guitar, you need to call <code>disconnect</code> method on your source node:</p>
<pre class="language-js"><code class="language-js">lineInSource<span class="token punctuation">.</span><span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<h2>Volume control</h2>
<p>The last basic thing I want to show in this post ‚Äì volume control. Web Audio provides us with a gain node. It has only one parameter ‚Äì gain. This parameter accepts any numeric value. The zero gain means muted sound, 1 means normal, the same volume level. You could use values bigger than 1 to amplify original sound; for example, the value of 2 will boost volume in two times. You can create a gain node using a factory method on audio context or using constructor. The main difference between those methods that constructor allows you to pass initial configuration parameters, at the same time, you create an instance. Let‚Äôs see it in code:</p>
<pre class="language-js"><code class="language-js"><span class="token comment">// Create a gain node and set the initial value to 0.5</span>
<span class="token comment">// that means that volume will be haft of the original.</span>
<span class="token keyword">const</span> gainNode <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GainNode</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token punctuation">{</span>gain<span class="token punctuation">:</span> <span class="token number">0.5</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Disconnect source before constructing a new graph.</span>
lineInSource<span class="token punctuation">.</span><span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Connect nodes</span>
lineInSource<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>gainNode<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>destination<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Increasing volume.</span>
gainNode<span class="token punctuation">.</span>gain<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
</code></pre>
<p>Few points to explain here, you can chain connect methods, as they are returning the node you connected to during the previous call. You can assign value to gain node, but you might notice clicking on value changes. Those ‚Äúclicks‚Äù are artifacts of discrete gain changes. Fortunately, Web Audio nodes have a bunch of methods to set values smoothly:</p>
<pre class="language-js"><code class="language-js"><span class="token comment">// Setting target value (1st argument) starting from</span>
<span class="token comment">// the current time in 0.01 second period</span>
gainNode<span class="token punctuation">.</span>gain<span class="token punctuation">.</span><span class="token function">setTargetAtTime</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> context<span class="token punctuation">.</span>currentTime<span class="token punctuation">,</span> <span class="token number">0.01</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Doing the same but exponentially.</span>
gainNode<span class="token punctuation">.</span>gain<span class="token punctuation">.</span><span class="token function">exponentialRampToValueAtTime</span><span class="token punctuation">(</span>gain<span class="token punctuation">,</span> context<span class="token punctuation">.</span>currentTime <span class="token operator">+</span> <span class="token number">0.01</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>Using those methods, you will avoid sound glitches. To update a value of the volume in a user interface you need some control, the most suitable one for that purpose is a range input:</p>
<pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation"><</span>input</span>
    <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>gain-control<span class="token punctuation">"</span></span>
    <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>range<span class="token punctuation">"</span></span>
    <span class="token attr-name">min</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span>
    <span class="token attr-name">max</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>1<span class="token punctuation">"</span></span>
    <span class="token attr-name">step</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>0.01<span class="token punctuation">"</span></span>
    <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>0.5<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
</code></pre>
<p>You can listen to the changes in the input to update the gain value. Note, that you will need to validate (at least clamp) and parse the value, cause inputs value is always a string.</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> control <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'.gain-control'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

control<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'change'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> parsed <span class="token operator">=</span> <span class="token function">parseFloat</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> value <span class="token operator">=</span> Number<span class="token punctuation">.</span><span class="token function">isNaN</span><span class="token punctuation">(</span>parsed<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token punctuation">:</span> parsed<span class="token punctuation">;</span>
  <span class="token keyword">const</span> clamped <span class="token operator">=</span> <span class="token function">clamp</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>

  gainNode<span class="token punctuation">.</span>gain<span class="token punctuation">.</span><span class="token function">setTargetAtTime</span><span class="token punctuation">(</span>clamped<span class="token punctuation">,</span> context<span class="token punctuation">.</span>currentTime<span class="token punctuation">,</span> <span class="token number">0.01</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">clamp</span><span class="token punctuation">(</span>min<span class="token punctuation">,</span> max<span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> min<span class="token punctuation">)</span><span class="token punctuation">,</span> max<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h2>Recap</h2>
<p>If you read that post to that point, you learned how to create an audio context, request media stream from a browser, connect it to the output, and control its volume. If you are playing guitar, you can check out the <a href="http://js-rocks.web.app" target="_blank" rel="nofollow noreferrer noopener">‚ÄúJS Rocks‚Äù</a> Angular app I‚Äôve built. It has a bunch of ready-to-use cabinets and effects for electric guitar created with Web Audio. Moreover, it sounds well üòé. Stay tuned in the <a href="https://bobrov.dev/blog/web-audio-for-electric-guitar-cabinet-emulation/">next post</a> I‚Äôm going to show how to emulate a real guitar cabinet. Rock it with Web Audio ü§ò!</p>
<script defer src="https://cdn.commento.io/js/commento.js" data-css-override="https://bobrov.dev/css/commento.css"></script></body></html>