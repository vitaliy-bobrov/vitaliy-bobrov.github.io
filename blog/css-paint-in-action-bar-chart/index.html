<html><head><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content="@bobrov1989"><meta name="twitter:title" content="CSS Paint in Action: Bar Chart"><meta name="twitter:description" content="We are going to create data visualizations that could be used in production projects -- bar chart. More than 65% of humans are visual learners. Visualization makes it easier to understand, compare, and analyze data. Using CSS Paint API, we can encapsulate all logic related to drawing charts on canvas and expose the high-level declarative interface."><meta name="twitter:image" content="https://bobrov.dev/images/posts/css-paint-in-action-bar-chart/css-paint-in-action-bar-chart-og.jpg"><meta name="twitter:image:alt" content="CSS Paint in Action: Bar Chart"></head><body><p>In my <a href="/blog/exploring-the-css-paint-api/">previous article</a>, we discovered CSS Paint API basics. Today, with this knowledge arsenal we are going to create data visualizations that could be used in production projects ‚Äì bar chart. More than 65% of humans are visual learners. Visualization makes it easier to understand, compare, and analyze data. Using CSS Paint API, we can encapsulate all logic related to drawing charts on canvas and expose the high-level declarative interface.</p>
<p>The most uncomplicated graph we can create is a bar chart üìä. It is the set of rectangles, possibly with a different background color, and the size of each box represents its value compared to the others. Usually, the maximum dataset value is taken as 100% on the target axis. So in our example, we will use the range from zero to the maximum amount of the given dataset for values axis, as in 90% cases this is what we need to implement. On the secondary axis, we will linearly distribute our bars and separate them with the gap in pixels specified by the passed argument.</p>
<p>To create a custom painter we need to follow three easy steps: declare a custom paint class, register paint, and load worklet. So let‚Äôs start with the painter class definition:</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">BarChartPainter</span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> <span class="token keyword">get</span> <span class="token function">inputProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span>
      <span class="token string">'--bar-map'</span><span class="token punctuation">,</span>
      <span class="token string">'--bar-gap'</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">paint</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> geom<span class="token punctuation">,</span> props<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Here will be our paint implementation.</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>So, for now, our <code>paint</code> method does nothing ü§•, the only thing we declared is the static <code>inputProperties</code> getter. This getter will return the list of CSS variable our painter relies on, that means that after each change of the value of these variables the browser will call the <code>paint</code> method.</p>
<h2>Dataset</h2>
<p>Our first variable stands for the dataset and we will use it to draw the chart. My first thought was to use Custom Properties API from Houdini for them and use something like the <code><color-stop></color-stop></code> type. <code><color-stop></color-stop></code> is the pair of percentage or length value and CSS color. Value and color are separated by spaces. The list of <code><color-stop></color-stop></code> value is used on the <code>linear-gradient</code> function, to declare that we want to use a list of Typed OM values we need to add <code>+</code> at the end of type declaration ‚Äì <code><color-stop>+</color-stop></code>. Unfortunately, for now, <code>CSS.registerProperty</code> doesn‚Äôt support lists and <code><color-stop></color-stop></code> type.</p>
<pre class="language-js"><code class="language-js"><span class="token constant">CSS</span><span class="token punctuation">.</span><span class="token function">registerProperty</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  name<span class="token punctuation">:</span> <span class="token string">'--data-points'</span><span class="token punctuation">,</span>
  syntax<span class="token punctuation">:</span> <span class="token string">'<color-stop>'</color-stop></span><span class="token punctuation">,</span>
  inherits<span class="token punctuation">:</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token constant">CSS</span><span class="token punctuation">.</span><span class="token function">registerProperty</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  name<span class="token punctuation">:</span> <span class="token string">'--data-colors'</span><span class="token punctuation">,</span>
  syntax<span class="token punctuation">:</span> <span class="token string">'<color>+'</color></span><span class="token punctuation">,</span>
  inherits<span class="token punctuation">:</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

Uncaught DOMException<span class="token punctuation">:</span> Failed to execute <span class="token string">'registerProperty'</span> on <span class="token string">'CSS'</span><span class="token punctuation">:</span>
The syntax provided is not a valid custom property syntax<span class="token punctuation">.</span>
</code></pre>
<p>Such an argument will cause <code>DOMException</code> errors. After my initial idea failed, I decided to follow with a CSS variable with a special syntax. CSS variables are just strings that will be interpolated in the place that they are used.</p>
<pre class="language-css"><code class="language-css"><span class="token selector"><span class="token class">.hello-var</span> </span><span class="token punctuation">{</span>
  <span class="token property">--my-varialbe</span><span class="token punctuation">:</span> <span class="token string">'hello world'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector"><span class="token class">.hello-var</span><span class="token pseudo-element">:after</span> </span><span class="token punctuation">{</span>
  <span class="token property">content</span><span class="token punctuation">:</span> <span class="token function">var</span><span class="token punctuation">(</span>--my-varialbe<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Text ‚Äúhello world‚Äù will be used as the value for <code>after</code> pseudo-element <code>content</code> property. That is completely equivalent to:</p>
<pre class="language-css"><code class="language-css"><span class="token selector"><span class="token class">.hello-var</span><span class="token pseudo-element">:after</span> </span><span class="token punctuation">{</span>
  <span class="token property">content</span><span class="token punctuation">:</span> <span class="token string">'hello world'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>So I decided to use <code>number</code> and <code>color</code> pairs delimited by a comma. Each number will represent the value for bar and color will be used for the background. This implementation has a big issue as we can‚Äôt use commas in color or value. I think it is ok for now to stay with that, as I wouldn‚Äôt want to complicate tutorial with <code>RexExp</code>. Here how our dataset should look like:</p>
<pre class="language-css"><code class="language-css"><span class="token selector"><span class="token class">.bars</span> </span><span class="token punctuation">{</span>
  <span class="token property">--bar-map</span><span class="token punctuation">:</span> <span class="token number">50</span> <span class="token hexcode">#666</span>, <span class="token number">70</span> salmon, <span class="token number">35</span> <span class="token hexcode">#9ee7a1</span>, <span class="token number">15</span> <span class="token hexcode">#fff</span>, <span class="token number">25</span> orange<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h2>Data Parsing</h2>
<p>After the input format decision has been made we can implement a helper method to parse it in our painter class:</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">BarChartPainter</span> <span class="token punctuation">{</span>
  <span class="token function">_parseData</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> input<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>entry <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token punctuation">[</span>value<span class="token punctuation">,</span> color<span class="token punctuation">]</span> <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token punctuation">{</span>
          value<span class="token punctuation">:</span> <span class="token function">parseFloat</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">,</span>
          color<span class="token punctuation">:</span> color <span class="token operator">||</span> <span class="token string">'black'</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Nothing special here, we pass our CSS variable input and transform it into the list of objects. Additionally, we added fallbacks for the value and color. Next, we will add the helper method to get the maximum value from the given dataset:</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">BarChartPainter</span> <span class="token punctuation">{</span>
  <span class="token function">_getMax</span><span class="token punctuation">(</span>dataset<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> dataset<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span>maxVal<span class="token punctuation">,</span> entry<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> maxVal <span class="token operator"><</span> entry<span class="token punctuation">.</span>value <span class="token operator">?</span> entry<span class="token punctuation">.</span>value <span class="token punctuation">:</span> maxVal<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h2>Drawing bars</h2>
<p>For the beginning let‚Äôs make vertical bars, other orientation support will be in our ‚ÄúTo Do‚Äù list. We are going to implement the main ‚Äì <code>paint</code> method:</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">BarChartPainter</span> <span class="token punctuation">{</span>
  <span class="token function">paint</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token punctuation">{</span>width<span class="token punctuation">,</span> height<span class="token punctuation">}</span><span class="token punctuation">,</span> props<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> gap <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>
      <span class="token punctuation">(</span>props<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'--bar-gap'</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token number">10</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_parseData</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'--bar-map'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> max <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_getMax</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> multiplier <span class="token operator">=</span> height <span class="token operator">/</span> max<span class="token punctuation">;</span>
    <span class="token keyword">const</span> barW <span class="token operator">=</span> <span class="token punctuation">(</span>width <span class="token operator">-</span> <span class="token punctuation">(</span>gap <span class="token operator">*</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> data<span class="token punctuation">.</span>length<span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator"><</span> data<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> x <span class="token operator">=</span> i <span class="token operator">*</span> <span class="token punctuation">(</span>barW <span class="token operator">+</span> gap<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> barHeight <span class="token operator">=</span> data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>value <span class="token operator">*</span> multiplier<span class="token punctuation">;</span>
      <span class="token keyword">const</span> y <span class="token operator">=</span> height <span class="token operator">-</span> barHeight<span class="token punctuation">;</span>

      ctx<span class="token punctuation">.</span>fillStyle <span class="token operator">=</span> data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>color<span class="token punctuation">;</span>

      ctx<span class="token punctuation">.</span><span class="token function">fillRect</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> barW<span class="token punctuation">,</span> barHeight<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Let‚Äôs take a look at this method line-by-line üßê. First of all, we are trying to get the <code>--bar-gap</code> variable and parse it as an integer. If there is no gap defined <code>props.get('--bar-gap')</code> will return <code>null</code> so we were providing a fallback value before calling <code>toString</code>. Then we are parsing our dataset stored in the <code>--bar-map</code> variable and getting the maximum value using helpers that we defined before. Then we are calculating how much height one value point should be by dividing the canvas height by the maximum value. After that, we are calculating the width of each bar. And finally, we are iterating our dataset and drawing rectangles for each of the values.</p>
<p>Now we are ready to register our paint:</p>
<pre class="language-js"><code class="language-js"><span class="token function">registerPaint</span><span class="token punctuation">(</span><span class="token string">'bar-chart'</span><span class="token punctuation">,</span> BarChartPainter<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>Here is the full content of our worklet JavaScript file:</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">BarChartPainter</span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> <span class="token keyword">get</span> <span class="token function">inputProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span>
      <span class="token string">'--bar-map'</span><span class="token punctuation">,</span>
      <span class="token string">'--bar-gap'</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">_parseData</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> input<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>entry <span class="token operator">=></span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token punctuation">[</span>value<span class="token punctuation">,</span> color<span class="token punctuation">]</span> <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">return</span> <span class="token punctuation">{</span>
        value<span class="token punctuation">:</span> <span class="token function">parseFloat</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">,</span>
        color<span class="token punctuation">:</span> color <span class="token operator">||</span> <span class="token string">'black'</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">_getMax</span><span class="token punctuation">(</span>dataset<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> dataset<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span>maxVal<span class="token punctuation">,</span> entry<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> maxVal <span class="token operator"><</span> entry<span class="token punctuation">.</span>value <span class="token operator">?</span> entry<span class="token punctuation">.</span>value <span class="token punctuation">:</span> maxVal<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">paint</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token punctuation">{</span>width<span class="token punctuation">,</span> height<span class="token punctuation">}</span><span class="token punctuation">,</span> props<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> gap <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>
      <span class="token punctuation">(</span>props<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'--bar-gap'</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token number">10</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_parseData</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'--bar-map'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> max <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_getMax</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> multiplier <span class="token operator">=</span> height <span class="token operator">/</span> max<span class="token punctuation">;</span>
    <span class="token keyword">const</span> barW <span class="token operator">=</span> <span class="token punctuation">(</span>width <span class="token operator">-</span> <span class="token punctuation">(</span>gap <span class="token operator">*</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> data<span class="token punctuation">.</span>length<span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator"><</span> data<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> x <span class="token operator">=</span> i <span class="token operator">*</span> <span class="token punctuation">(</span>barW <span class="token operator">+</span> gap<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> barHeight <span class="token operator">=</span> data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>value <span class="token operator">*</span> multiplier<span class="token punctuation">;</span>
      <span class="token keyword">const</span> y <span class="token operator">=</span> height <span class="token operator">-</span> barHeight<span class="token punctuation">;</span>

      ctx<span class="token punctuation">.</span>fillStyle <span class="token operator">=</span> data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>color<span class="token punctuation">;</span>

      ctx<span class="token punctuation">.</span><span class="token function">fillRect</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> barW<span class="token punctuation">,</span> barHeight<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token function">registerPaint</span><span class="token punctuation">(</span><span class="token string">'bar-chart'</span><span class="token punctuation">,</span> BarChartPainter<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<h2>Loading the worklet</h2>
<p>So to have the ability to use our custom painter in the stylesheet, we need to load our worklet:</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">'paintWorklet'</span> <span class="token keyword">in</span> <span class="token constant">CSS</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token constant">CSS</span><span class="token punctuation">.</span>paintWorklet<span class="token punctuation">.</span><span class="token function">addModule</span><span class="token punctuation">(</span><span class="token string">'paint.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>I called my file <code>paint.js</code> and then loaded it using the <code>CSS.paintWorklet.addModule</code> method. Not long ago <a href="https://twitter.com/dassurma" target="_blank" rel="nofollow noreferrer noopener">Surma</a>, main Houdini project supporter, published an interesting <a href="https://twitter.com/DasSurma/status/983305990731894785" target="_blank" rel="nofollow noreferrer noopener">cheat</a> on how to avoid additional HTTP requests to load worklets. We can‚Äôt write worklet code as inline JavaScript because it shouldn‚Äôt have access to the global scope. All worklets are executed in a separate browser context with insufficient functionality for security reasons. Inside this context we can use only a small subset of 2D canvas, a few global JS functions and helpers, like <code>parseInt</code> or <code>Math</code>, but not <code>setInterval</code>, <code>setTimeout</code> or <code>requestAnimationFrame</code>. The idea behind Surma‚Äôs worklet embedding method is to write inline code inside the <code>script</code> tag but with different a language type, to avoid its execution. Then we can convert it to <code>Blob</code> objects and create an object URL from it. Here is the code example:</p>
<pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation"><</span>script</span> <span class="token attr-name">language</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>javascript+paint<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script language-javascript">
  <span class="token keyword">class</span> <span class="token class-name">BarChartPainter</span> <span class="token punctuation">{</span>
    <span class="token function">paint</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> geom<span class="token punctuation">,</span> props<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">registerPaint</span><span class="token punctuation">(</span><span class="token string">'bar-chart'</span><span class="token punctuation">,</span> BarChartPainter<span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="token tag"><span class="token tag"><span class="token punctuation"><!--</span-->script</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation"><</span>script</span><span class="token punctuation">></span></span><span class="token script language-javascript">
  <span class="token keyword">function</span> <span class="token function">blobWorklet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> src <span class="token operator">=</span> document
      <span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'script[language$="paint"]'</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>innerHTML<span class="token punctuation">;</span>
    <span class="token keyword">const</span> blob <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Blob</span><span class="token punctuation">(</span><span class="token punctuation">[</span>src<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>type<span class="token punctuation">:</span> <span class="token string">'text/javascript'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token constant">URL</span><span class="token punctuation">.</span><span class="token function">createObjectURL</span><span class="token punctuation">(</span>blob<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">'paintWorklet'</span> <span class="token keyword">in</span> <span class="token constant">CSS</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token constant">CSS</span><span class="token punctuation">.</span>paintWorklet<span class="token punctuation">.</span><span class="token function">addModule</span><span class="token punctuation">(</span><span class="token function">blobWorklet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</span><span class="token tag"><span class="token tag"><span class="token punctuation"><!--</span-->script</span><span class="token punctuation">></span></span>
</span></span></code></pre>
<p>Using this trick, we avoid sending additional HTTP requests to load CSS Paint worklet.</p>
<h2>Using worklet</h2>
<p>After our painter is registered and loaded we can call it in the CSS:</p>
<pre class="language-css"><code class="language-css"><span class="token selector"><span class="token class">.bars</span> </span><span class="token punctuation">{</span>
  <span class="token property">height</span><span class="token punctuation">:</span> <span class="token number">700</span>px<span class="token punctuation">;</span>
  <span class="token property">max-height</span><span class="token punctuation">:</span> <span class="token number">50</span>vh<span class="token punctuation">;</span>
  <span class="token property">--bar-map</span><span class="token punctuation">:</span> <span class="token number">50</span> <span class="token hexcode">#666</span>, <span class="token number">70</span> salmon, <span class="token number">35</span> <span class="token hexcode">#9ee7a1</span>, <span class="token number">15</span> <span class="token hexcode">#fff</span>, <span class="token number">25</span> orange<span class="token punctuation">;</span>
  <span class="token property">--bar-gap</span><span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">;</span>
  <span class="token property">background</span><span class="token punctuation">:</span> <span class="token hexcode">#111</span> <span class="token function">paint</span><span class="token punctuation">(</span>bar-chart<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token atrule"><span class="token rule">@supports</span> not <span class="token punctuation">(</span><span class="token property">background</span><span class="token punctuation">:</span> <span class="token function">paint</span><span class="token punctuation">(</span>bar-chart<span class="token punctuation">)</span><span class="token punctuation">)</span></span> <span class="token punctuation">{</span>
  <span class="token selector"><span class="token class">.bars</span><span class="token pseudo-element">:after</span> </span><span class="token punctuation">{</span>
    <span class="token property">content</span><span class="token punctuation">:</span> <span class="token string">'Your browser does not support CSS Paint API :('</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>We declared <code>--bar-map</code> and <code>--bar-gap</code> variables and called the custom paint using <code>paint(bar-chart)</code>. We set a solid background color as well. Also, I have added a feature detection with <code>@supports</code> rule. Using this if a browser doesn‚Äôt support the CSS Paint API will show an appropriate message to the user.</p>
<h2>Improvements</h2>
<p>We have already created a bar chart MVP and now is the time to think about its improvements. Actually, there are a lot of points to improve, and I am not going to cover all of them. If you want to implement more feel free to fork my repository and do it, just don‚Äôt forget to share your ideas in the comments below and social networks (on Twitter please ping <a href="https://twitter.com/bobrov1989" target="_blank" rel="nofollow noreferrer noopener">me</a>).</p>
<h3><strong>Note:</strong></h3>
<p><em>There is a bug related to Typed OM that used as input properties in worklet. For the demos below</em> <code>props.get('padding')</code> <em>returns</em> <code>CSSUnitValue</code> <em>object without</em> <code>unit</code> <em>and</em> <code>value</code> <em>properties. The only way is to use <code>toString</code> method on it. If you are facing any issues viewing demos, try to enable ‚ÄúExperimental Web Platform features‚Äù</em> ‚Äì <code>chrome://flags/#enable-experimental-web-platform-features</code> <em>to fix it.</em></p>
<p>So the first point I want to cover is to add the possibility to define offsets for our chart. And I‚Äôm going to use the <code>padding</code> property for that. Here is the updated painter class:</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">BarChartPainter</span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> <span class="token keyword">get</span> <span class="token function">inputProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span>
      <span class="token string">'--bar-map'</span><span class="token punctuation">,</span>
      <span class="token string">'--bar-gap'</span><span class="token punctuation">,</span>
      <span class="token string">'padding-top'</span><span class="token punctuation">,</span>
      <span class="token string">'padding-right'</span><span class="token punctuation">,</span>
      <span class="token string">'padding-bottom'</span><span class="token punctuation">,</span>
      <span class="token string">'padding-left'</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">paint</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> geom<span class="token punctuation">,</span> props<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> gap <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>
      <span class="token punctuation">(</span>props<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'--bar-gap'</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token number">10</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> padding <span class="token operator">=</span> <span class="token punctuation">{</span>
      top<span class="token punctuation">:</span> props<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'padding-top'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">,</span>
      right<span class="token punctuation">:</span> props<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'padding-right'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">,</span>
      bottom<span class="token punctuation">:</span> props<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'padding-bottom'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">,</span>
      left<span class="token punctuation">:</span> props<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'padding-left'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> width <span class="token operator">=</span> geom<span class="token punctuation">.</span>width <span class="token operator">-</span> padding<span class="token punctuation">.</span>left <span class="token operator">-</span> padding<span class="token punctuation">.</span>right<span class="token punctuation">;</span>
    <span class="token keyword">const</span> height <span class="token operator">=</span> geom<span class="token punctuation">.</span>height <span class="token operator">-</span> padding<span class="token punctuation">.</span>top <span class="token operator">-</span> padding<span class="token punctuation">.</span>bottom<span class="token punctuation">;</span>
    <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_parseData</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'--bar-map'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> max <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_getMax</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> multiplier <span class="token operator">=</span> height <span class="token operator">/</span> max<span class="token punctuation">;</span>
    <span class="token keyword">const</span> barW <span class="token operator">=</span> <span class="token punctuation">(</span>width <span class="token operator">-</span> <span class="token punctuation">(</span>gap <span class="token operator">*</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> data<span class="token punctuation">.</span>length<span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator"><</span> data<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> x <span class="token operator">=</span> i <span class="token operator">*</span> <span class="token punctuation">(</span>barW <span class="token operator">+</span> gap<span class="token punctuation">)</span> <span class="token operator">+</span> padding<span class="token punctuation">.</span>left<span class="token punctuation">;</span>
      <span class="token keyword">const</span> barHeight <span class="token operator">=</span> data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>value <span class="token operator">*</span> multiplier<span class="token punctuation">;</span>
      <span class="token keyword">const</span> y <span class="token operator">=</span> height <span class="token operator">-</span> barHeight <span class="token operator">+</span> padding<span class="token punctuation">.</span>top<span class="token punctuation">;</span>

      ctx<span class="token punctuation">.</span>fillStyle <span class="token operator">=</span> data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>color<span class="token punctuation">;</span>

      ctx<span class="token punctuation">.</span><span class="token function">fillRect</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> barW<span class="token punctuation">,</span> barHeight<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Now we are using padding values to calculate bar width and height. Next, I want to add the possibility to change chart orientation. I will introduce the <code>--bar-placement</code> variable with possible values: top, bottom, left and right. Here is the final code:</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">BarChartPainter</span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> <span class="token keyword">get</span> <span class="token function">inputProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span>
      <span class="token string">'--bar-map'</span><span class="token punctuation">,</span>
      <span class="token string">'--bar-placement'</span><span class="token punctuation">,</span>
      <span class="token string">'--bar-gap'</span><span class="token punctuation">,</span>
      <span class="token string">'padding-top'</span><span class="token punctuation">,</span>
      <span class="token string">'padding-right'</span><span class="token punctuation">,</span>
      <span class="token string">'padding-bottom'</span><span class="token punctuation">,</span>
      <span class="token string">'padding-left'</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">_parseData</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> input<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>entry <span class="token operator">=></span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token punctuation">[</span>value<span class="token punctuation">,</span> color<span class="token punctuation">]</span> <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">return</span> <span class="token punctuation">{</span>
        value<span class="token punctuation">:</span> <span class="token function">parseFloat</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">,</span>
        color<span class="token punctuation">:</span> color <span class="token operator">||</span> <span class="token string">'black'</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">_getMax</span><span class="token punctuation">(</span>dataset<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> dataset<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span>maxVal<span class="token punctuation">,</span> entry<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> maxVal <span class="token operator"><</span> entry<span class="token punctuation">.</span>value <span class="token operator">?</span> entry<span class="token punctuation">.</span>value <span class="token punctuation">:</span> maxVal<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">paint</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> geom<span class="token punctuation">,</span> props<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> position <span class="token operator">=</span> props<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'--bar-placement'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> gap <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'--bar-gap'</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> padding <span class="token operator">=</span> <span class="token punctuation">{</span>
      top<span class="token punctuation">:</span> props<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'padding-top'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">,</span>
      right<span class="token punctuation">:</span> props<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'padding-right'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">,</span>
      bottom<span class="token punctuation">:</span> props<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'padding-bottom'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">,</span>
      left<span class="token punctuation">:</span> props<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'padding-left'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> vertical <span class="token operator">=</span> position <span class="token operator">===</span> <span class="token string">'top'</span> <span class="token operator">||</span> position <span class="token operator">===</span> <span class="token string">'bottom'</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> width <span class="token operator">=</span> geom<span class="token punctuation">.</span>width <span class="token operator">-</span> padding<span class="token punctuation">.</span>left <span class="token operator">-</span> padding<span class="token punctuation">.</span>right<span class="token punctuation">;</span>
    <span class="token keyword">const</span> height <span class="token operator">=</span> geom<span class="token punctuation">.</span>height <span class="token operator">-</span> padding<span class="token punctuation">.</span>top <span class="token operator">-</span> padding<span class="token punctuation">.</span>bottom<span class="token punctuation">;</span>
    <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_parseData</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'--bar-map'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> max <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_getMax</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> domain <span class="token operator">=</span> vertical <span class="token operator">?</span> height <span class="token punctuation">:</span> width<span class="token punctuation">;</span>
    <span class="token keyword">const</span> baseWidth <span class="token operator">=</span> vertical <span class="token operator">?</span> width <span class="token punctuation">:</span> height<span class="token punctuation">;</span>
    <span class="token keyword">const</span> multiplier <span class="token operator">=</span> domain <span class="token operator">/</span> max<span class="token punctuation">;</span>
    <span class="token keyword">const</span> barW <span class="token operator">=</span> <span class="token punctuation">(</span>baseWidth <span class="token operator">-</span> <span class="token punctuation">(</span>gap <span class="token operator">*</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> data<span class="token punctuation">.</span>length<span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator"><</span> data<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> x <span class="token operator">=</span> i <span class="token operator">*</span> <span class="token punctuation">(</span>barW <span class="token operator">+</span> gap<span class="token punctuation">)</span> <span class="token operator">+</span> padding<span class="token punctuation">.</span>left<span class="token punctuation">;</span>
      <span class="token keyword">const</span> barH <span class="token operator">=</span> data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>value <span class="token operator">*</span> multiplier<span class="token punctuation">;</span>
      <span class="token keyword">const</span> y <span class="token operator">=</span> <span class="token punctuation">{</span>
        top<span class="token punctuation">:</span> padding<span class="token punctuation">.</span>top<span class="token punctuation">,</span>
        right<span class="token punctuation">:</span> domain <span class="token operator">-</span> barH <span class="token operator">+</span> padding<span class="token punctuation">.</span>left<span class="token punctuation">,</span>
        bottom<span class="token punctuation">:</span> domain <span class="token operator">-</span> barH <span class="token operator">+</span> padding<span class="token punctuation">.</span>top<span class="token punctuation">,</span>
        left<span class="token punctuation">:</span> padding<span class="token punctuation">.</span>left
      <span class="token punctuation">}</span><span class="token punctuation">[</span>position<span class="token punctuation">]</span><span class="token punctuation">;</span>

      ctx<span class="token punctuation">.</span>fillStyle <span class="token operator">=</span> data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>color<span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>vertical<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ctx<span class="token punctuation">.</span><span class="token function">fillRect</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> barW<span class="token punctuation">,</span> barH<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        ctx<span class="token punctuation">.</span><span class="token function">fillRect</span><span class="token punctuation">(</span>y<span class="token punctuation">,</span> x<span class="token punctuation">,</span> barH<span class="token punctuation">,</span> barW<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>And the updated styles:</p>
<pre class="language-css"><code class="language-css"><span class="token selector"><span class="token class">.bars</span> </span><span class="token punctuation">{</span>
  <span class="token property">height</span><span class="token punctuation">:</span> <span class="token number">700</span>px<span class="token punctuation">;</span>
  <span class="token property">max-height</span><span class="token punctuation">:</span> <span class="token number">50</span>vh<span class="token punctuation">;</span>
  <span class="token property">padding</span><span class="token punctuation">:</span> <span class="token number">30</span>px <span class="token number">10</span>px <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token property">--bar-placement</span><span class="token punctuation">:</span> bottom<span class="token punctuation">;</span>
  <span class="token property">--bar-gap</span><span class="token punctuation">:</span> <span class="token number">40</span><span class="token punctuation">;</span>
  <span class="token property">--bar-map</span><span class="token punctuation">:</span> <span class="token number">50</span> <span class="token hexcode">#666</span>, <span class="token number">70</span> salmon, <span class="token number">35</span> <span class="token hexcode">#9ee7a1</span>, <span class="token number">15</span> <span class="token hexcode">#fff</span>, <span class="token number">25</span> orange<span class="token punctuation">;</span>
  <span class="token property">background</span><span class="token punctuation">:</span> <span class="token hexcode">#111</span> <span class="token function">paint</span><span class="token punctuation">(</span>bar-chart<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p></p><div class="remarkable-youtube-wrapper">
    <iframe class="remarkable-youtube js-lazy-load" data-src="https://www.youtube.com/embed/dn1bwJPQY5I?origin=https://bobrov.dev/&rel=0" frameborder="0" allow="encrypted-media" allowfullscreen></iframe>
  </div><p></p>
<p>As usual you can check <a href="https://github.com/vitaliy-bobrov/css-paint-demos/tree/master/src/bar" target="_blank" rel="nofollow noreferrer noopener">code</a> and <a href="https://bobrov.dev/css-paint-demos/bar/">demo</a>.</p>
<h2>Change the input format</h2>
<p>After thinking for some time, I decided to change the dataset input using "JS in CSS". Yes, you read it correctly, I want to use JavaScript inside CSS. As I said before, our worklet code is executed in a secure and separate context and in this case, it is completely fine to use some JS as a CSS variable value. Then I‚Äôm going to parse this value in a custom painter using <code>JSON.parse</code>. Let‚Äôs look at stylesheet first:</p>
<pre class="language-css"><code class="language-css"><span class="token selector"><span class="token class">.bars</span> </span><span class="token punctuation">{</span>
  <span class="token selector">height: 700px;
  max-height: 50vh;
  padding: 10px;
  background: <span class="token id">#111</span> paint(bar-chart);
  --bar-placement: bottom;
  --bar-gap: 40;
  --bar-map: [
    </span><span class="token punctuation">{</span>
      <span class="token string">"value"</span><span class="token punctuation">:</span> <span class="token number">55</span>,
      <span class="token string">"color"</span><span class="token punctuation">:</span> <span class="token string">"rgba(250, 128, 114, .8)"</span>
    <span class="token punctuation">}</span><span class="token selector">,
    </span><span class="token punctuation">{</span>
      <span class="token string">"value"</span><span class="token punctuation">:</span> <span class="token number">10</span>,
      <span class="token string">"color"</span><span class="token punctuation">:</span> <span class="token string">"rgba(102, 51, 153, .9)"</span>
    <span class="token punctuation">}</span><span class="token selector">,
    </span><span class="token punctuation">{</span>
      <span class="token string">"value"</span><span class="token punctuation">:</span> <span class="token number">120</span>,
      <span class="token string">"color"</span><span class="token punctuation">:</span> <span class="token string">"hsl(39, 100%, 50%)"</span>
    <span class="token punctuation">}</span><span class="token selector">,
    </span><span class="token punctuation">{</span>
      <span class="token string">"value"</span><span class="token punctuation">:</span> <span class="token number">36.8</span>,
      <span class="token string">"color"</span><span class="token punctuation">:</span> <span class="token string">"#666"</span>
    <span class="token punctuation">}</span><span class="token selector">,
    </span><span class="token punctuation">{</span>
      <span class="token string">"value"</span><span class="token punctuation">:</span> <span class="token number">97.5</span>,
      <span class="token string">"color"</span><span class="token punctuation">:</span> <span class="token string">"#9ee7a1"</span>
    <span class="token punctuation">}</span>
  ]<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>So I defined a JSON array with data objects in my CSS! This rule looks strange but more verbose than the special string before. So now I can remove the <code>_parseData</code> method from the painter class and use <code>JSON.parse</code> instead:</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">BarChartPainter</span> <span class="token punctuation">{</span>
  <span class="token function">paint</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> geom<span class="token punctuation">,</span> props<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>

    <span class="token comment">// Much simplier data parsing!</span>
    <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'--bar-map'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>How is it useful? Now we can get CSS variables in JavaScript, change the data and animate it! Then we need to call <code>JSON.stringify</code> and set the new value. Without JavaScript we can swap the data, on hover for example:</p>
<pre class="language-css"><code class="language-css"><span class="token selector"><span class="token class">.bars</span><span class="token pseudo-class">:hover</span> </span><span class="token punctuation">{</span>
  <span class="token selector">--bar-map: [
    </span><span class="token punctuation">{</span>
      <span class="token string">"value"</span><span class="token punctuation">:</span> <span class="token number">5</span>,
      <span class="token string">"color"</span><span class="token punctuation">:</span> <span class="token string">"rgba(250, 128, 114, .8)"</span>
    <span class="token punctuation">}</span><span class="token selector">,
    </span><span class="token punctuation">{</span>
      <span class="token string">"value"</span><span class="token punctuation">:</span> <span class="token number">100</span>,
      <span class="token string">"color"</span><span class="token punctuation">:</span> <span class="token string">"rgba(102, 51, 153, .9)"</span>
    <span class="token punctuation">}</span><span class="token selector">,
    </span><span class="token punctuation">{</span>
      <span class="token string">"value"</span><span class="token punctuation">:</span> <span class="token number">21</span>,
      <span class="token string">"color"</span><span class="token punctuation">:</span> <span class="token string">"hsl(39, 100%, 50%)"</span>
    <span class="token punctuation">}</span><span class="token selector">,
    </span><span class="token punctuation">{</span>
      <span class="token string">"value"</span><span class="token punctuation">:</span> <span class="token number">120</span>,
      <span class="token string">"color"</span><span class="token punctuation">:</span> <span class="token string">"#666"</span>
    <span class="token punctuation">}</span><span class="token selector">,
    </span><span class="token punctuation">{</span>
      <span class="token string">"value"</span><span class="token punctuation">:</span> <span class="token number">37</span>,
      <span class="token string">"color"</span><span class="token punctuation">:</span> <span class="token string">"#9ee7a1"</span>
    <span class="token punctuation">}</span>
  ]<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p></p><div class="remarkable-youtube-wrapper">
    <iframe class="remarkable-youtube js-lazy-load" data-src="https://www.youtube.com/embed/toWY6fmpmQg?origin=https://bobrov.dev/&rel=0" frameborder="0" allow="encrypted-media" allowfullscreen></iframe>
  </div><p></p>
<p><a href="https://github.com/vitaliy-bobrov/css-paint-demos/tree/master/src/bar-js-in-css" target="_blank" rel="nofollow noreferrer noopener">Code</a> and <a href="https://bobrov.dev/css-paint-demos/bar-js-in-css/">demo</a>.</p>
<p>Now let‚Äôs try to animate the dataset in JavaScript:</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'.bars'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> style <span class="token operator">=</span> <span class="token function">getComputedStyle</span><span class="token punctuation">(</span>canvas<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> initialValues <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>style<span class="token punctuation">.</span><span class="token function">getPropertyValue</span><span class="token punctuation">(</span><span class="token string">'--bar-map'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>v <span class="token operator">=></span> v<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">TIME</span> <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">rand</span><span class="token punctuation">(</span>max<span class="token punctuation">,</span> min<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>max <span class="token operator">-</span> min <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> min<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">animate</span><span class="token punctuation">(</span>values<span class="token punctuation">,</span> time<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> start <span class="token operator">=</span> performance<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> style <span class="token operator">=</span> <span class="token function">getComputedStyle</span><span class="token punctuation">(</span>canvas<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>style<span class="token punctuation">.</span><span class="token function">getPropertyValue</span><span class="token punctuation">(</span><span class="token string">'--bar-map'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> fromData <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>v <span class="token operator">=></span> v<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> increments <span class="token operator">=</span> fromData<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> i<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token punctuation">(</span>v <span class="token operator">-</span> values<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> time<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">raf</span><span class="token punctuation">(</span>now<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> count <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>now <span class="token operator">-</span> start<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> value <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> i<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span>
        <span class="token operator">...</span>s<span class="token punctuation">,</span>
        value<span class="token punctuation">:</span> fromData<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token punctuation">(</span>increments<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">*</span> count<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    canvas<span class="token punctuation">.</span>style<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">'--bar-map'</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>count <span class="token operator">></span> time<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> final <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> i<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span>
          <span class="token operator">...</span>s<span class="token punctuation">,</span>
          value<span class="token punctuation">:</span> values<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      canvas<span class="token punctuation">.</span>style<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">'--bar-map'</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>final<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span>raf<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'mouseenter'</span><span class="token punctuation">,</span> event <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> values <span class="token operator">=</span> initialValues<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">rand</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">120</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span><span class="token function">animate</span><span class="token punctuation">(</span>values<span class="token punctuation">,</span> <span class="token constant">TIME</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

canvas<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'mouseleave'</span><span class="token punctuation">,</span> event <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span><span class="token function">animate</span><span class="token punctuation">(</span>initialValues<span class="token punctuation">,</span> <span class="token constant">TIME</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>So using <code>requestAnimationFrame</code> on mouse enter I animated the dataset from the initial value to the random data set and in opposite direction on mouse leave. Also, I‚Äôve added the <code>--bar-max</code> variable to set the range for the main axis from zero to this value.</p>
<p></p><div class="remarkable-youtube-wrapper">
    <iframe class="remarkable-youtube js-lazy-load" data-src="https://www.youtube.com/embed/kUgWZsoyjqU?origin=https://bobrov.dev/&rel=0" frameborder="0" allow="encrypted-media" allowfullscreen></iframe>
  </div><p></p>
<p><a href="https://github.com/vitaliy-bobrov/css-paint-demos/tree/master/src/bar-animate" target="_blank" rel="nofollow noreferrer noopener">Code</a> and <a href="https://bobrov.dev/css-paint-demos/bar-animate/">demo</a>.</p>
<p>After all, I‚Äôve tried to go further and fetch the JSON file with the custom property of <code><url></url></code> or <code><img></code> type. URL type doesn‚Äôt seem to work, it just got the string value from it. Such resource fetched exclusively when used as a value for properties accepting URLs. The image appears to work but doesn‚Äôt parse the JSON data as it has only mime types related to image formats in request headers.</p>
<h2>Recap</h2>
<p>Today we implemented a basic bar chart, then extend its functionality, tried to use JavaScript in CSS and animate data with <code>requestAnimationFrame</code>. I hope this was awesome, and as I still experimenting with Houdini APIs more exciting posts will come üòé. Let‚Äôs keep in touch ü§ü!</p>
<script defer src="https://cdn.commento.io/js/commento.js" data-css-override="https://bobrov.dev/css/commento.css"></script></body></html>