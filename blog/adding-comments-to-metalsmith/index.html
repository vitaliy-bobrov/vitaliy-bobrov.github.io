<html><head><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content="@bobrov1989"><meta name="twitter:title" content="Adding Comments to Metalsmith"><meta name="twitter:description" content="Comments are the vital part of communication with the audience. It fits for a lot type of websites starting from blogs finishing with e-commerce. Metalsmith is a static site generator, that means that developer doesn't want to have a database and other back-end infrastructure to implement commenting functionality."><meta name="twitter:image" content="https://bobrov.dev/images/posts/adding-comments-to-metalsmith/add-comments-to-metalsmith-project-og.jpg"><meta name="twitter:image:alt" content="Adding Comments to Metalsmith"></head><body><p>Comments are the vital part of communication with the audience. It fits for a lot type of websites starting from blogs finishing with e-commerce. Metalsmith is a static site generator, that means (in most cases) that developer doesn’t want to have a database and other back-end infrastructure to implement commenting functionality. But it not says that you can’t add it.</p>
<p>Some services provide commenting widgets as a service in web. The most widely-used and famous of them – <a href="https://disqus.com/" target="_blank" rel="nofollow noreferrer noopener">Disqus</a>. With it, you will not care about a lot of complicated things related to comments. So what they offer to you:</p>
<ul><li>Commenting widget</li>
<li>Real-time comments updates</li>
<li>Comments counter widget</li>
<li>Spam filtering</li>
<li>Moderation tool</li>
<li>Design adapting to your website</li>
<li>Media resources support</li>
</ul>
<p>The site registration is pretty simple, just visit Disqus <a href="https://disqus.com/profile/signup/intent/" target="_blank" rel="nofollow noreferrer noopener">webpage</a> and follow the instructions.</p>
<h2>Integrate with Metalsmith</h2>
<p>Metalsmith was created as flexible as possible, and it has a little core functionality. Any additional feature could be implemented as a plugin. So to simplify Disqus integration I created <a href="https://github.com/vitaliy-bobrov/metalsmith-disqus" target="_blank" rel="nofollow noreferrer noopener">plugin</a> – <code>metalsmith-disqus</code>.</p>
<p class="star-me"><a href="https://github.com/vitaliy-bobrov/metalsmith-disqus" target="_blank" rel="nofollow noreferrer noopener">Star on GitHub</a></p>
<h3>Installation</h3>
<p>The installation process is pretty simple, just run the command in your terminal:</p>
<pre class="language-bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> --save-dev metalsmith-disqus
</code></pre>
<h3>Plug into Metalsmith build</h3>
<p>The plugin needs HTML markup to be already generated for its work because it will look for elements with configured class names and add Disqus scripts, meta tags to your page. So you need to place it after markdown files are processed, for example after <code>metalsmith-layouts</code> plugin:</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> Metalsmith <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'metalsmith'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> layouts    <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'metalsmith-layouts'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> disqus     <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'metalsmith-disqus'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">Metalsmith</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">)</span>
  <span class="token operator">...</span>
  <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">layouts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">disqus</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    siteurl<span class="token punctuation">:</span> <span class="token string">'my-site.com'</span><span class="token punctuation">,</span>
    shortname<span class="token punctuation">:</span> <span class="token string">'my-site'</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<h3>Required options</h3>
<p>You need to specify two required configuration options – <code>siteurl</code> and <code>shortname</code>. <code>siteurl</code> – needed to generate absolute URL for your pages. That is required for proper Disqus widget configuration. <code>shortname</code> is the same name that you received during website registration in Disqus admin. Disqus gives the links to widgets based on your shortname sub-domain. All other options are optional, if not specified plugin will use defaults.</p>
<h3>Optional configuration</h3>
<p><code>path</code> - Metalsmith metadata key to finding your page relative path. It is used to generate absolute URL to the page, using <code>path</code> and <code>siteurl</code>. If you are using <code>metalsmith-permalinks</code> plugin you could leave it as default value – 'path’, this plugin adds <code>path</code> property to your content. Otherwise, you may pass own front matter key to the configuration:</p>
<pre class="language-js"><code class="language-js"><span class="token function">Metalsmith</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">)</span>
  <span class="token operator">...</span>
  <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">disqus</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    siteurl<span class="token punctuation">:</span> <span class="token string">'my-site.com'</span><span class="token punctuation">,</span>
    shortname<span class="token punctuation">:</span> <span class="token string">'my-site'</span><span class="token punctuation">,</span>
    path<span class="token punctuation">:</span> <span class="token string">'alias'</span> <span class="token comment">// Used `alias` property to find page path.</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p><code>path</code> - Metalsmith metadata key to finding your page title that will be used in comments widget configuration. Default value – 'title’. You may pass own front matter key to the configuration:</p>
<pre class="language-js"><code class="language-js"><span class="token function">Metalsmith</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">)</span>
  <span class="token operator">...</span>
  <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">disqus</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    siteurl<span class="token punctuation">:</span> <span class="token string">'my-site.com'</span><span class="token punctuation">,</span>
    shortname<span class="token punctuation">:</span> <span class="token string">'my-site'</span><span class="token punctuation">,</span>
    title<span class="token punctuation">:</span> <span class="token string">'label'</span> <span class="token comment">// Used `label` property to find page title.</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p><code>identifier</code> - Metalsmith metadata key to finding your page property from which plugin will generate the unique value. This value will be used in Disqus to define content page unique id. It will help Disqus to add the same commenting widget to all content instances, that may have few aliases, for example, the page may be available by few URLs or under different network protocols. Default value – 'title’, <code>metalsmith-disqus</code> will take the content title and sluglify it. You may pass own front matter key to the configuration:</p>
<pre class="language-js"><code class="language-js"><span class="token function">Metalsmith</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">)</span>
  <span class="token operator">...</span>
  <span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">disqus</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    siteurl<span class="token punctuation">:</span> <span class="token string">'my-site.com'</span><span class="token punctuation">,</span>
    shortname<span class="token punctuation">:</span> <span class="token string">'my-site'</span><span class="token punctuation">,</span>
    identifier<span class="token punctuation">:</span> <span class="token string">'uuid'</span> <span class="token comment">// Used `uuid` property to generate unique id.</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p><code>counterSelector</code> - a string that represents CSS class name selector for counter widget container. By default plugin is looking for <code>.disqus-comment-count</code> elements in markup. Then it will add Disqus identifiers to HTML elements, so disqus widget will know what comments amount to insert inside which of them. Now only selectors starting with class name definition works.</p>
<h3>Widgets insertion</h3>
<p>There are two widgets possible to use from Disqus – the commenting widget and comments counter. To use comments widgets just add <code>comments: true</code> to content front matter data:</p>
<pre class="language-yaml"><code class="language-yaml"><span class="token punctuation">---</span>
<span class="token key atrule">title</span><span class="token punctuation">:</span> Hello World
<span class="token key atrule">comments</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token punctuation">---</span>
</code></pre>
<p>But wouldn’t be enough, you need to add HTML container for Disqus comments inside your page template with id <code>disqus_thread</code>, if you’re using handlebars as template engine it may look like this:</p>
<pre class="language-html"><code class="language-html">{{#if comments }}
<span class="token comment"><!-- Comments widget will be rendered in this element --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation"><</span>section</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>disqus_thread<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation"><!--</span-->section</span><span class="token punctuation">></span></span>
{{/if}}
</span></code></pre>
<p>The same manipulations needed for comments count widget, just enable <code>comments-counter: true</code> in metadata and add a container to insert text with some comments. The difference is that for the container you should use the class name <code>disqus-comment-count</code> (configured by default) or specify any CSS class with <code>counterSelector</code> option. Also, you need to render property to that is used as <code>identifier</code> in your settings (<code>title</code> by default) inside <code>data-disqus-key</code> attribute. This data-attribute in necessary to insert correct counter to proper content:</p>
<pre class="language-yaml"><code class="language-yaml"><span class="token punctuation">---</span>
<span class="token key atrule">title</span><span class="token punctuation">:</span> My page
<span class="token key atrule">comments-counter</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token punctuation">---</span>
</code></pre>
<pre class="language-html"><code class="language-html">{{#if comments }}
<span class="token comment"><!-- Comments counter will be rendered in this element --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation"><</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>disqus-comment-count<span class="token punctuation">"</span></span> <span class="token attr-name">data-disqus-key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>{{title}}<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation"><!--</span-->span</span><span class="token punctuation">></span></span>
{{/if}}
</span></code></pre>
<h3>Performance optimizations</h3>
<p>As a bonus, the plugin can prefetch Disqus DNS and preload scripts by simple parameters in YAML front matter. Adding <code>disqus-dns-prefetch: true</code> will add line tag that will tell the browser to start resolving disqus hosts earlier to decrease library loading time. Other parameters: <code>disqus-prefetch-widget: true</code> and <code>disqus-prefetch-counter: true</code> will force modern browsers to start loading scripts before they are requested by the user.</p>
<p>Let’s imagine real project situation when you have a page(s) with listings of content that have comments, and if you add <code>disqus-prefetch-widget: true</code> to this pages, while user is discovering this content, modern browsers could load commenting widget script. Then after the transition to the content page, widget JavaScript will be already in place. You can check this feature support <a href="http://caniuse.com/#feat=link-rel-prefetch" target="_blank" rel="nofollow noreferrer noopener">here</a>. It is cost nothing to add it, and it will not affect unsupported browsers.</p>
<h2>Let’s keep in touch</h2>
<p>If you have any issues or any ideas regarding new features, please leave them <a href="https://github.com/vitaliy-bobrov/metalsmith-disqus/issues" target="_blank" rel="nofollow noreferrer noopener">here</a>.</p>
<script defer src="https://cdn.commento.io/js/commento.js" data-css-override="https://bobrov.dev/css/commento.css"></script></body></html>