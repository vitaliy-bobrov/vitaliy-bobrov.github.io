<html><head><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content="@bobrov1989"><meta name="twitter:title" content="Web Audio for Electric Guitar: Cabinet Emulation"><meta name="twitter:description" content="Want to know how to emulate top brand guitar amp or cabinet playing on electric guitar in a web browser? Read how to use convolution and Web Audio API to get a great sound."><meta name="twitter:image" content="https://bobrov.dev/images/posts/web-audio-for-electric-guitar-cabinet-emulation/web-audio-for-electric-guitar-cabinet-emulation-og.jpg"><meta name="twitter:image:alt" content="Web Audio for Electric Guitar: Cabinet Emulation"></head><body><p>It is hard to imagine a guitarist without any amplifier or guitar cabinet. Even more without any speakers, an electric guitar is hard to hear even at home. Today I want to show how to emulate guitar cabinet using Web Audio API. It is possible to recreate a sound made by top brand amp without the investment of thousands of dollars using convolution.</p>
<p>In the <a href="https://bobrov.dev/blog/web-audio-for-electric-guitar-how-to-connect-instrument/">previous post</a>, I described the process of getting sound from an electric guitar in a browser using Web Audio. Today I‚Äôm continuing that series with guitar cabinet emulation.</p>
<p><em>This post is a part of ‚ÄúWeb Audio for Electric Guitar‚Äù series, check out other posts as well!</em></p>
<h3 class="post__series">Web Audio for Electric Guitar Series:</h3>
<ol class="post__series"><li><a href="https://bobrov.dev/blog/web-audio-for-electric-guitar-how-to-connect-instrument/">How to Connect Instrument</a></li>
<li>Cabinet Emulation ‚Äì Current</li>
<li><a href="https://bobrov.dev/blog/web-audio-for-electric-guitar-distortion">Distortion</a></li>
</ol>
<p>While playing on electric guitar at home, it usually connected to an individual device ‚Äì amplifier or head with a cabinet. There are a lot of famous amp producers, and each of them has its own ‚Äúfirm‚Äù sound. However, using digital sound processing, it is possible to emulate them programmatically using a process called <em>convolution</em>. For simplicity, you can imagine convolution as a multiplication of two functions. When we are speaking about sound convolution mean the application of some sample to the live input. To simulate a guitar cabinet, we need to apply such a short sample recorded from real device to guitar sound. That samples called <em>impulse response</em> (IR).</p>
<h2>Impulse Response</h2>
<p>An impulse response is a recording of an amp impulse characteristics such as amplitude or frequency. For example, a photo is a snapshot of a light that the camera got on a film or digital matrix at some point. You can think about impulse response in the same way. It is a snapshot of a live speaker.</p>
<p class="js-lazy-load"><img src="/images/posts/web-audio-for-electric-guitar-cabinet-emulation/img/amp-config-panel.jpg" alt="AMP config panel"></p>
<p>Unfortunately, that snapshot is limited to only one particular setting is recorded. What I mean by this is that on the real amplifier, you have a bunch of controls like volume or equalizer, and depending on amp configuration, you get different impulse response. So you can only simulate a device with a particular configuration. However, we can implement equalizer using Web Audio as well. Equalization gives us some flexibility to get the sound shape we want.</p>
<h2>Convolver Node</h2>
<p>Now we have an idea what we want to perform, and it is time to learn how to implement that using Web Audio API. The API hides much heavy math behind nodes it provides. Convolution is not an exception ‚Äì we have a Convolver Node to apply impulse response to audio stream:</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AudioContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> convolver <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConvolverNode</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>The convolver node has a <code>buffer</code> option that is used to pass an impulse response audio buffer. You must load an audio file with the IR in a format browser understands. Modern browsers support different formats that happened because of those formats licensing. Modern browsers have excellent support of WAV (all except IE, that doesn‚Äôt support Web Audio as well), AAC (Firefox supports it only in an MP4 container), MP3, FLAC, and OGG (all except IE and Safari). I considered staying with WAV as it is well-supported and is a lossless audio format. The quality is essential here because we are using a very short ‚Äì just a few bytes recordings and the compression could create artifacts in the output.</p>
<p>If you want to provide various file formats depending on the current browser you can check the support:</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> audio <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'audio'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>audio<span class="token punctuation">.</span><span class="token function">canPlayType</span><span class="token punctuation">(</span><span class="token string">'audio/wav'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// "maybe"</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>audio<span class="token punctuation">.</span><span class="token function">canPlayType</span><span class="token punctuation">(</span><span class="token string">'audio/wav'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'The format is not supported!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>All browsers, including IE 9+ support ‚ÄòcanPlayType‚Äô method. It returns a string with 3 possible values: <code>'maybe'</code>, <code>'probably'</code>, and <code>''</code>. Yes, it couldn‚Äôt give you an exact answer ü§£, only probabilistic one. The empty string means that the format is not supported. <code>'maybe'</code> ‚Äì can‚Äôt answer without starting playback, and <code>'probably'</code> ‚Äì seems to be possible.</p>
<p class="js-lazy-load"><img src="/images/posts/web-audio-for-electric-guitar-cabinet-emulation/img/studio.jpg" alt="Real recording studio"></p>
<p>You might have a reasonable question where you can get those cabinets to impulse responses? You can "do it your self"‚Ñ¢Ô∏è ‚Äì but this variant requires you to have a cabinet itself and a bunch of additional equipment, like capacitor microphone, professional audio card, and so far and so forth. Luckily there are a lot of free high-quality impulse responses made by professional studios and enthusiasts. Just google for "<a href="https://www.google.com/search?q=free+cabinet+impulse+response&rlz=1C5CHFA_enUA690UA690&oq=free+cabinet+impulse+response" target="_blank" rel="nofollow noreferrer noopener">free cabinet impulse response</a>" to find and download one. If you are too lazy you can check the <a href="https://github.com/vitaliy-bobrov/js-rocks/tree/master/src/assets/impulses/cabinet" target="_blank" rel="nofollow noreferrer noopener">impulses</a> I‚Äôm using for a "<a href="https://js-rocks.web.app" target="_blank" rel="nofollow noreferrer noopener">JS Rocks</a>" app.</p>
<p>After we have an IR to work with, we can load and apply it to the Convolver Node using audio context and Fetch API:</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> convolver <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConvolverNode</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'impulse.wav'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>response <span class="token operator">=></span> response<span class="token punctuation">.</span><span class="token function">arrayBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>buffer <span class="token operator">=></span> <span class="token punctuation">{</span>
    context<span class="token punctuation">.</span><span class="token function">decodeAudioData</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> decoded <span class="token operator">=></span> <span class="token punctuation">{</span>
    convolver<span class="token punctuation">.</span>buffer <span class="token operator">=</span> decoded<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p><em>Note: it is essential to disconnect/connect Convolver Node after a new buffer set if you want to re-use the same node few times. If you set a new buffer on the connected node the old buffer will be used, and possibly you  get audio glitches.</em></p>
<p>We fetched the impulse response file, then transform the response into array buffer. We can‚Äôt apply that buffer directly on convolver, before that we need to decode it using context. When convolver configured you can chain it in your audio processing graph:</p>
<pre class="language-js"><code class="language-js">guitarInput<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>convolver<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>destination<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>Some IR could have a low amplitude, so after you apply it, they might reduce the overall volume. In this case, you can boost it using a Gain Node:</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> makeUpGain <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GainNode</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token comment">// Need to be adjusted to a particular IR.</span>
  gain<span class="token punctuation">:</span> <span class="token number">5</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

guitarInput
  <span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>convolver<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>makeUpGain<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>destination<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>The gain value needs to be adjusted manually for a particular impulse response. It is also good to expose that configuration in the user interface with some control like range input.</p>
<h2>Three-band Equalizer</h2>
<p>The last feature I want to add to cabinet emulation is a three-band equalizer. It gives us the tone control of the output. We want to create a configurable filter for bass, middle and treble frequencies. All below 500 Hz will is related to bass, between 500 Hz and 3 KHz to the middle, and above 3000 Hz to treble.</p>
<p class="js-lazy-load"><img src="/images/posts/web-audio-for-electric-guitar-cabinet-emulation/img/3-band-equalizer.jpg" alt="Three-band equalizer frequencies split"></p>
<p>How can we increase the output of particular frequencies using Web Audio? We have a great node for that ‚Äì Biquad Filter Node. It is an implementation of a group of filters, that could be specified by provided type value. For bass control, we pick a <code>'lowshelf'</code> filter. It will increase the level of all frequencies below passed one. For treble, we use the opposite type ‚Äì <code>'highshelf'</code>. It boosts everything above the passed value. Moreover, for middle, we choose <code>'peaking'</code> type. It boosts frequencies around passed value ‚Äì the range of the band controlled by the <code>Q</code> (filter quality) parameter. Attenuation or boost for each band changed by gain parameter. It is an amount of level change in dB applied to the frequencies, using negative values we attenuate it, using positive ‚Äì boosting.</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> bassNode <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BiquadFilterNode</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  type<span class="token punctuation">:</span> <span class="token string">'lowshelf'</span><span class="token punctuation">,</span>
  frequency<span class="token punctuation">:</span> <span class="token number">500</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> midNode <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BiquadFilterNode</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  type<span class="token punctuation">:</span> <span class="token string">'peaking'</span><span class="token punctuation">,</span>
  <span class="token constant">Q</span><span class="token punctuation">:</span> Math<span class="token punctuation">.</span><span class="token constant">SQRT1_2</span><span class="token punctuation">,</span>
  frequency<span class="token punctuation">:</span> <span class="token number">1500</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> trebleNode <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BiquadFilterNode</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  type<span class="token punctuation">:</span> <span class="token string">'highshelf'</span><span class="token punctuation">,</span>
  frequency<span class="token punctuation">:</span> <span class="token number">3000</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Decreasing bass level by 10 dB.</span>
bassNode<span class="token punctuation">.</span>gain<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">;</span>

<span class="token comment">// Increasing middle level by 15 dB.</span>
midNode<span class="token punctuation">.</span>gain<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token number">15</span><span class="token punctuation">;</span>

<span class="token comment">// No boost.</span>
trebleNode<span class="token punctuation">.</span>gain<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
</code></pre>
<p>To prevent click on gain value updates it is possible to use <code>setTargetAtTime</code> update method:</p>
<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> level <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> duration <span class="token operator">=</span> <span class="token number">0.01</span><span class="token punctuation">;</span>

midNode<span class="token punctuation">.</span>gain<span class="token punctuation">.</span><span class="token function">setTargetAtTime</span><span class="token punctuation">(</span>level<span class="token punctuation">,</span> context<span class="token punctuation">.</span>currentTime<span class="token punctuation">,</span> duration<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>Now we can connect all the nodes to have a flexible guitar cabinet emulation:</p>
<pre class="language-js"><code class="language-js">guitarInput
  <span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>convolver<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>makeUpGain<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>bassNode<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>midNode<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>trebleNode<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>destination<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>I‚Äôve recorded an example video showing how convolution affects the output sound. It might not have a significant impact on a clean signal, but if some distortion effect applied, it is much more noticeable.</p>
<p></p><div class="remarkable-youtube-wrapper">
    <iframe class="remarkable-youtube js-lazy-load" data-src="https://www.youtube.com/embed/0KK6D2h7RgU?origin=https://bobrov.dev/&rel=0" frameborder="0" allow="encrypted-media" allowfullscreen></iframe>
  </div><p></p>
<h2>Recap</h2>
<p>If you read that post to that point, you learned how to emulate a guitar amp using convolution, and create a three-band equalizer to configure tone. If you are playing guitar, you can check out the <a href="http://js-rocks.web.app" target="_blank" rel="nofollow noreferrer noopener">‚ÄúJS Rocks‚Äù</a> Angular app I‚Äôve built. It has 9‚ÄºÔ∏è of ready-to-use cabinets and  7 effects for electric guitar created with Web Audio. Moreover, it sounds well üòé. Stay tuned in the next post I‚Äôm going to make a deep dive into <a href="https://bobrov.dev/blog/web-audio-for-electric-guitar-distortion">distortion effects</a>. Rock it with Web Audio ü§ò!</p>
<script defer src="https://cdn.commento.io/js/commento.js" data-css-override="https://bobrov.dev/css/commento.css"></script></body></html>